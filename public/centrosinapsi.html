<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Centro Sinapsi - Proposta Sviluppo</title>
    <meta name="description" content="Proposta sviluppo Progressive Web Application per Centro Sinapsi - Domenico Riccio Web & App Solutions">
    <meta name="robots" content="noindex, nofollow">

    <!-- jsPDF per generazione PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c5aa0, #4CAF50);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-card {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-card h2 {
            color: #2c5aa0;
            margin-bottom: 30px;
            font-size: clamp(22px, 5vw, 28px);
        }

        .login-card p {
            color: #666;
            margin-bottom: 30px;
            font-size: clamp(14px, 3vw, 16px);
        }

        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .password-input:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2c5aa0, #4CAF50);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(44, 90, 160, 0.3);
        }

        .error-message {
            color: #ff6b35;
            margin-top: 15px;
            font-size: clamp(12px, 2.5vw, 14px);
            display: none;
        }

        /* Timer Display */
        .timer-display {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px;
            text-align: center;
            margin: -20px -20px 30px -20px;
            font-weight: bold;
            font-size: clamp(13px, 2.8vw, 15px);
        }

        .timer-display.expired {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        /* 🧪 TEST MODE BANNER */
        .test-mode-banner {
            background: linear-gradient(135deg, #9C27B0, #673AB7);
            color: white;
            padding: 15px;
            text-align: center;
            margin: -20px -20px 30px -20px;
            font-weight: bold;
            font-size: clamp(13px, 2.8vw, 15px);
            border: 2px solid #fff;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: #2c5aa0;
            font-size: clamp(14px, 3vw, 16px);
            font-weight: bold;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2c5aa0, #4CAF50);
        }

        .status-banner {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px;
            text-align: center;
            margin: -20px -20px 30px -20px;
            font-weight: bold;
            display: none;
        }

        .status-banner.signed {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            display: block;
        }

        .header {
            background: white;
            color: #333;
            border-bottom: 4px solid #2c5aa0;
            padding-bottom: 25px;
            margin-bottom: 40px;
            position: relative;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .company-info h1 {
            color: #2c5aa0;
            font-size: clamp(24px, 5vw, 32px);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .company-info .tagline {
            font-size: clamp(14px, 3vw, 18px);
            color: #333;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .company-info p, .client-info p {
            font-size: clamp(12px, 2.5vw, 14px);
            margin-bottom: 3px;
            color: #333;
        }

        .client-info {
            text-align: right;
        }

        .client-info h2 {
            color: #2c5aa0;
            font-size: clamp(18px, 4vw, 24px);
            margin-bottom: 8px;
        }

        .app-title {
            text-align: center;
            margin: 40px 0;
            padding: 40px 20px;
            background: linear-gradient(135deg, #2c5aa0, #4CAF50);
            color: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(44, 90, 160, 0.3);
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        .app-title:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(44, 90, 160, 0.4);
        }

        .app-title h1 {
            font-size: clamp(28px, 6vw, 42px);
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .app-title p {
            font-size: clamp(16px, 4vw, 22px);
            opacity: 0.95;
        }

        .section {
            margin-bottom: 50px;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section h2 {
            color: #2c5aa0;
            font-size: clamp(18px, 4vw, 26px);
            margin-bottom: 25px;
            border-bottom: 3px solid #e3f2fd;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            position: relative;
        }

        .section h2::before {
            content: "▶";
            margin-right: 15px;
            color: #4CAF50;
            font-size: 0.8em;
        }

        .services-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin: 30px 0;
        }

        .service-category {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            padding: 30px;
            border-radius: 15px;
            border-left: 5px solid #2c5aa0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .service-category::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #2c5aa0, #4CAF50);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .service-category:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.12);
        }

        .service-category:hover::before {
            transform: scaleX(1);
        }

        .service-category h3 {
            color: #2c5aa0;
            margin-bottom: 20px;
            font-size: clamp(16px, 3.5vw, 22px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .service-price {
            color: #4CAF50;
            font-weight: bold;
            font-size: clamp(16px, 3.5vw, 20px);
            background: linear-gradient(135deg, #e8f5e8, #f0fff0);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #4CAF50;
        }

        .service-list {
            list-style: none;
            padding: 0;
        }

        .service-list li {
            margin-bottom: 12px;
            padding-left: 25px;
            position: relative;
            color: #555;
            font-size: clamp(13px, 2.8vw, 15px);
            line-height: 1.5;
            transition: color 0.2s ease;
        }

        .service-list li:hover {
            color: #2c5aa0;
        }

        .service-list li::before {
            content: "✓";
            color: #4CAF50;
            font-weight: bold;
            position: absolute;
            left: 0;
            font-size: 1.2em;
        }

        .tech-stack {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 35px;
            border-radius: 20px;
            margin: 40px 0;
            box-shadow: 0 10px 30px rgba(44, 90, 160, 0.1);
        }

        .tech-stack h3 {
            color: #2c5aa0;
            margin-bottom: 20px;
            font-size: clamp(16px, 3.5vw, 20px);
            text-align: center;
        }

        .tech-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .tech-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #2c5aa0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tech-item:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(44, 90, 160, 0.2);
            border-color: #4CAF50;
        }

        .tech-item h4 {
            color: #2c5aa0;
            margin-bottom: 8px;
            font-size: clamp(12px, 2.5vw, 16px);
        }

        .tech-item p {
            font-size: clamp(11px, 2vw, 13px);
            color: #666;
        }

        .pricing-summary {
            background: linear-gradient(135deg, #f8f9fa, #e3f2fd);
            padding: 40px;
            border-radius: 20px;
            margin: 40px 0;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }

        .pricing-summary h3 {
            color: #2c5aa0;
            text-align: center;
            margin-bottom: 30px;
            font-size: clamp(18px, 4vw, 24px);
        }

        .price-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .price-table th {
            background: linear-gradient(135deg, #2c5aa0, #1e4080);
            color: white;
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            font-size: clamp(14px, 3vw, 16px);
        }

        .price-table td {
            padding: 18px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: clamp(13px, 2.8vw, 15px);
        }

        .price-table .service-name {
            font-weight: 600;
            color: #333;
        }

        .price-table .price {
            text-align: right;
            font-weight: bold;
            color: #2c5aa0;
        }

        .total-row {
            background: linear-gradient(135deg, #f0f7ff, #e3f2fd);
            font-weight: bold;
            font-size: clamp(14px, 3vw, 18px);
        }

        .discount-row {
            background: linear-gradient(135deg, #e8f5e8, #f0fff0);
            color: #4CAF50;
            font-weight: bold;
            font-size: clamp(14px, 3vw, 18px);
        }

        .final-row {
            background: linear-gradient(135deg, #2c5aa0, #1e4080);
            color: white;
            font-weight: bold;
            font-size: clamp(16px, 3.5vw, 20px);
        }

        .discount-highlight {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        }

        .discount-highlight h3 {
            color: #ff6b35;
            margin-bottom: 15px;
            font-size: clamp(16px, 3.5vw, 20px);
        }

        .timeline-section {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            padding: 35px;
            border-radius: 20px;
            margin: 40px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        .timeline-section h3 {
            color: #2c5aa0;
            margin-bottom: 25px;
            font-size: clamp(16px, 3.5vw, 20px);
            text-align: center;
        }

        .timeline-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border-left: 5px solid #2c5aa0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            transform: translateX(10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .timeline-item .week {
            background: linear-gradient(135deg, #2c5aa0, #1e4080);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            margin-right: 20px;
            min-width: 120px;
            text-align: center;
            font-size: clamp(12px, 2.5vw, 14px);
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-content strong {
            color: #2c5aa0;
            font-size: clamp(14px, 3vw, 16px);
        }

        .payment-options {
            background: linear-gradient(135deg, #f0f7ff, #e3f2fd);
            padding: 35px;
            border-radius: 20px;
            margin: 40px 0;
            box-shadow: 0 10px 30px rgba(44, 90, 160, 0.1);
        }

        .payment-options h3 {
            color: #2c5aa0;
            margin-bottom: 25px;
            font-size: clamp(16px, 3.5vw, 20px);
            text-align: center;
        }

        .payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .payment-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #4CAF50;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            position: relative;
        }

        .payment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(76, 175, 80, 0.2);
        }

        .payment-card.selected {
            border-color: #2c5aa0;
            box-shadow: 0 15px 40px rgba(44, 90, 160, 0.3);
        }

        .payment-card-full {
            background: white;
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #4CAF50;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            margin-top: 25px;
            position: relative;
        }

        .payment-card-full.selected {
            border-color: #2c5aa0;
            box-shadow: 0 15px 40px rgba(44, 90, 160, 0.3);
        }

        .payment-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .payment-badge.extended {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        .total-payment-row {
            background: linear-gradient(135deg, #2c5aa0, #1e4080) !important;
            color: white !important;
            font-weight: bold !important;
        }

        .total-payment-row td {
            color: white !important;
            font-weight: bold !important;
        }

        .custom-payment-section {
            margin-top: 20px;
        }

        .custom-payment-intro {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #2c5aa0;
        }

        .custom-payment-intro p {
            margin-bottom: 10px;
            font-size: clamp(13px, 2.8vw, 15px);
            line-height: 1.5;
        }

        .custom-payment-intro p:last-child {
            margin-bottom: 0;
        }

        .custom-payment-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2c5aa0;
            margin-bottom: 8px;
            font-size: clamp(13px, 2.8vw, 15px);
        }

        .form-input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: clamp(14px, 3vw, 16px);
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .form-input:invalid {
            border-color: #ff6b35;
        }

        .form-group small {
            font-size: clamp(11px, 2.2vw, 12px);
            color: #666;
            margin-top: 5px;
        }

        .calculation-result {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #4CAF50;
            margin-top: 20px;
        }

        .calculation-table {
            margin-bottom: 15px;
        }

        .validation-message {
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            font-size: clamp(13px, 2.8vw, 15px);
        }

        .validation-message.valid {
            background: linear-gradient(135deg, #e8f5e8, #f0fff0);
            color: #4CAF50;
            border: 2px solid #4CAF50;
        }

        .validation-message.invalid {
            background: linear-gradient(135deg, #ffebee, #fce4ec);
            color: #f44336;
            border: 2px solid #f44336;
        }

        .custom-payment-footer {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #2c5aa0;
        }

        .payment-card h4 {
            color: #4CAF50;
            margin-bottom: 20px;
            font-size: clamp(14px, 3vw, 18px);
        }

        .payment-table {
            width: 100%;
            border-collapse: collapse;
        }

        .payment-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: clamp(12px, 2.5vw, 14px);
        }

        .cta-section {
            background: linear-gradient(135deg, #2c5aa0, #4CAF50);
            color: white;
            padding: 50px 30px;
            border-radius: 20px;
            text-align: center;
            margin: 50px 0;
            box-shadow: 0 20px 50px rgba(44, 90, 160, 0.3);
        }

        .cta-section h2 {
            font-size: clamp(20px, 5vw, 32px);
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cta-section p {
            font-size: clamp(14px, 3vw, 18px);
            margin-bottom: 15px;
            opacity: 0.95;
        }

        /* Sezione Firma Digitale */
        .signature-section {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            padding: 40px;
            border-radius: 20px;
            margin: 50px 0;
            border: 3px solid #2c5aa0;
            box-shadow: 0 15px 40px rgba(44, 90, 160, 0.15);
        }

        .signature-section h2 {
            color: #2c5aa0;
            text-align: center;
            margin-bottom: 30px;
            font-size: clamp(20px, 4.5vw, 28px);
        }

        .signature-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .acceptance-checkboxes {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #4CAF50;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            font-size: clamp(13px, 2.8vw, 15px);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 15px;
            transform: scale(1.3);
            accent-color: #4CAF50;
            margin-top: 2px;
        }

        .checkbox-item label {
            cursor: pointer;
            line-height: 1.5;
            color: #333;
        }

        .signature-canvas-container {
            background: white;
            border: 3px dashed #2c5aa0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .signature-canvas {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: crosshair;
            width: 100%;
            max-width: 500px;
            height: 200px;
            background: #fafafa;
        }

        .signature-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: clamp(13px, 2.8vw, 15px);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-clear {
            background: #ff6b35;
            color: white;
        }

        .btn-clear:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }

        .btn-submit {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 40px;
            font-size: clamp(15px, 3vw, 18px);
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .signature-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: clamp(12px, 2.5vw, 14px);
            color: #666;
            text-align: center;
        }

        .success-message {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 30px 0;
            display: none;
            box-shadow: 0 15px 40px rgba(76, 175, 80, 0.3);
        }

        .success-message.show {
            display: block;
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .signature-preview {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #4CAF50;
            margin-top: 20px;
        }

        .signature-preview h4 {
            color: #2c5aa0;
            margin-bottom: 15px;
            font-size: clamp(14px, 3vw, 16px);
        }

        .signature-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            font-size: clamp(12px, 2.5vw, 14px);
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.2);
        }

        .info-box h3 {
            color: #ff6b35;
            margin-bottom: 15px;
            font-size: clamp(16px, 3.5vw, 20px);
        }

        .contact-section {
            background: linear-gradient(135deg, #f8f9fa, #e3f2fd);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin: 40px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        .contact-section h3 {
            color: #2c5aa0;
            margin-bottom: 25px;
            font-size: clamp(18px, 4vw, 24px);
        }

        .contact-section p {
            font-size: clamp(14px, 3vw, 18px);
            margin-bottom: 10px;
        }

        /* 🎯 STILI SPECIFICI PER LA STAMPA DEL PDF */
        .pdf-container {
            position: absolute;
            top: -10000px;
            left: 0;
            width: 210mm; /* A4 width */
            background: white;
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            color: #000;
            margin: 0;
            padding: 15mm;
            box-sizing: border-box;
        }

        .pdf-container * {
            -webkit-print-color-adjust: exact !important;
            color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .pdf-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20mm;
            margin-bottom: 10mm;
            padding-bottom: 8mm;
            border-bottom: 3px solid #2c5aa0;
        }

        .pdf-company-info h1 {
            color: #2c5aa0;
            font-size: 20pt;
            font-weight: bold;
            margin: 0 0 3mm 0;
        }

        .pdf-company-info .tagline {
            font-size: 12pt;
            font-weight: bold;
            margin-bottom: 5mm;
            color: #333;
        }

        .pdf-company-info p, .pdf-client-info p {
            font-size: 9pt;
            margin: 1mm 0;
            color: #000;
        }

        .pdf-client-info {
            text-align: right;
        }

        .pdf-client-info h2 {
            color: #2c5aa0;
            font-size: 16pt;
            font-weight: bold;
            margin: 0 0 3mm 0;
        }

        .pdf-title {
            text-align: center;
            margin: 15mm 0;
            padding: 20mm 10mm;
            background: linear-gradient(135deg, #2c5aa0, #4CAF50);
            color: white;
            border-radius: 10mm;
        }

        .pdf-title h1 {
            font-size: 24pt;
            font-weight: bold;
            margin: 0 0 5mm 0;
        }

        .pdf-title p {
            font-size: 14pt;
            margin: 0;
        }

        .pdf-section {
            margin-bottom: 15mm;
            page-break-inside: avoid;
        }

        .pdf-section h2 {
            color: #2c5aa0;
            font-size: 14pt;
            font-weight: bold;
            margin: 0 0 8mm 0;
            border-bottom: 2px solid #e3f2fd;
            padding-bottom: 3mm;
        }

        .pdf-service-category {
            background: #f8f9fa;
            padding: 8mm;
            margin-bottom: 8mm;
            border-left: 3mm solid #2c5aa0;
            border-radius: 3mm;
            page-break-inside: avoid;
        }

        .pdf-service-category h3 {
            color: #2c5aa0;
            font-size: 12pt;
            font-weight: bold;
            margin: 0 0 5mm 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-service-price {
            color: #4CAF50;
            font-weight: bold;
            background: #e8f5e8;
            padding: 2mm 5mm;
            border-radius: 5mm;
            border: 1px solid #4CAF50;
        }

        .pdf-service-list {
            list-style: none;
            padding: 0;
            margin: 5mm 0;
        }

        .pdf-service-list li {
            margin: 3mm 0;
            padding-left: 8mm;
            position: relative;
            font-size: 9pt;
            line-height: 1.3;
        }

        .pdf-service-list li::before {
            content: "✓";
            color: #4CAF50;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .pdf-price-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8mm 0;
            background: white;
            border-radius: 5mm;
            overflow: hidden;
        }

        .pdf-price-table th {
            background: #2c5aa0;
            color: white;
            padding: 5mm;
            text-align: left;
            font-weight: bold;
            font-size: 10pt;
        }

        .pdf-price-table td {
            padding: 5mm;
            border-bottom: 1px solid #f0f0f0;
            font-size: 9pt;
        }

        .pdf-signature-section {
            background: #f8f9fa;
            padding: 10mm;
            border-radius: 5mm;
            border: 2px solid #4CAF50;
            margin-top: 15mm;
            page-break-inside: avoid;
        }

        .pdf-signature-section h3 {
            color: #2c5aa0;
            font-size: 14pt;
            font-weight: bold;
            margin: 0 0 8mm 0;
            text-align: center;
        }

        .pdf-signature-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10mm;
            margin: 8mm 0;
        }

        .pdf-signature-details div {
            font-size: 9pt;
            margin: 2mm 0;
        }

        .pdf-signature-image {
            text-align: center;
            margin: 10mm 0;
            padding: 8mm;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3mm;
        }

        .pdf-signature-image img {
            max-width: 60mm;
            max-height: 25mm;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
                border-radius: 10px;
            }

            .header {
                grid-template-columns: 1fr;
                gap: 20px;
                text-align: center;
            }

            .client-info {
                text-align: center;
            }

            .service-category h3 {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .tech-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .payment-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .custom-payment-form {
                padding: 20px;
            }

            .timeline-item {
                flex-direction: column;
                text-align: center;
            }

            .timeline-item .week {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .signature-controls {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 250px;
            }
        }

        @media (max-width: 480px) {
            .app-title {
                padding: 25px 15px;
            }

            .section {
                margin-bottom: 30px;
            }

            .service-category,
            .tech-stack,
            .pricing-summary,
            .timeline-section,
            .payment-options,
            .signature-section {
                padding: 20px;
            }

            .payment-card,
            .payment-card-full {
                padding: 20px;
            }

            .custom-payment-form {
                padding: 15px;
            }

            .custom-payment-intro {
                padding: 15px;
            }

            .form-input {
                padding: 10px 12px;
            }

            .payment-badge {
                font-size: 10px;
                padding: 6px 12px;
                right: 15px;
            }

            .price-table th,
            .price-table td {
                padding: 12px 8px;
            }
        }

        /* Print styles mantengono le ottimizzazioni precedenti */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            @page {
                margin: 12mm !important;
                size: A4 !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                font-size: 11px !important;
                line-height: 1.4 !important;
                margin: 0 !important;
            }

            .container {
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
                background: white !important;
            }

            .signature-section,
            .success-message,
            .timer-display,
            .test-mode-banner {
                display: none !important;
            }

            .header {
                background: white !important;
                color: #333 !important;
                margin-bottom: 5px !important;
                padding: 15px 0 5px 0 !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                border-bottom: 2px solid #2c5aa0 !important;
                keep-with-next: always !important;
                grid-template-columns: 1fr 1fr !important;
            }

            .app-title {
                margin: 0 0 15px 0 !important;
                padding: 15px !important;
                page-break-inside: avoid !important;
                page-break-before: avoid !important;
                page-break-after: avoid !important;
                break-inside: avoid !important;
                break-before: avoid !important;
                break-after: avoid !important;
                border-radius: 8px !important;
            }

            .section {
                margin-bottom: 20px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            .service-category,
            .tech-stack,
            .pricing-summary,
            .timeline-section,
            .payment-options {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin-bottom: 15px !important;
                padding: 12px !important;
            }

            .header + .app-title {
                page-break-before: avoid !important;
                break-before: avoid !important;
            }

            h1, h2, h3, h4 {
                page-break-after: avoid !important;
                break-after: avoid !important;
                orphans: 3 !important;
                widows: 3 !important;
                keep-with-next: always !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h2>🔐 Accesso Riservato</h2>
            <p>Proposta Centro Sinapsi PWA<br>Inserisci la password per accedere</p>
            <input type="password" id="passwordInput" class="password-input" placeholder="Password" />
            <button class="login-btn" onclick="checkPassword()">🚀 Accedi alla Proposta</button>
            <div class="error-message" id="errorMessage">⚠️ Password errata. Riprova.</div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Invio proposta firmata in corso...</div>
    </div>

    <div class="container" id="proposalContainer" style="display: none;">
        <!-- 🧪 TEST MODE BANNER -->
        <div class="test-mode-banner">
            🧪 MODALITÀ TEST ATTIVA - Firme multiple consentite per testing
        </div>

        <div class="timer-display" id="timerDisplay">
            ⏰ Tempo rimanente per firmare: <span id="timerText"></span>
        </div>

        <div class="status-banner" id="statusBanner">
            ✅ PROPOSTA FIRMATA E ACCETTATA DIGITALMENTE
        </div>

        <div class="header">
            <div class="company-info">
                <h1>Domenico Riccio</h1>
                <div class="tagline">Web & App Solutions</div>
                <p><strong>Sviluppatore Full-Stack Senior</strong></p>
                <p>Via Ol Mött 6, 6703 Osogna, Svizzera</p>
                <p>📞 Tel: 076 781 01 94</p>
                <p>✉️ Email: info@dcreativo.ch</p>
                <p>🌐 Web: dcreativo.ch</p>
            </div>
            <div class="client-info">
                <h2>Centro Sinapsi</h2>
                <p><strong>Shote - Proprietaria</strong></p>
                <p>Via Toron d'Örz 7, 6703 Osogna</p>
                <p>📞 Tel: 078 846 06 87</p>
                <p>✉️ Email: info@centrosinapsi.ch</p>
                <p style="margin-top: 15px; color: #666;"><strong>Data:</strong> <span id="currentDate"></span></p>
            </div>
        </div>

        <div class="app-title">
            <h1>🏠 Centro Sinapsi PWA</h1>
            <p>Progressive Web Application Completa</p>
        </div>

        <div class="section">
            <h2>🛠️ Servizi di Sviluppo Inclusi</h2>
            <div class="services-grid">

                <div class="service-category">
                    <h3>
                        🎯 Portale Clienti Completo
                        <span class="service-price">CHF 2'500</span>
                    </h3>
                    <ul class="service-list">
                        <li>Sistema registrazione e login sicuro con verifica email</li>
                        <li>Dashboard personalizzata per ogni famiglia</li>
                        <li>Gestione profili bambini (età, allergie, note mediche)</li>
                        <li>Sistema prenotazioni sala eventi con calendario interattivo</li>
                        <li>Iscrizione mensa scolastica (6-14 anni) con gestione posti</li>
                        <li>Richiesta doposcuola con aiuto compiti</li>
                        <li>Form digitali intelligenti per preventivi pulizie personalizzati</li>
                        <li>Pagamenti Stripe Link per mensa, doposcuola e noleggio sala</li>
                        <li>Storico completo di tutte le prenotazioni e servizi</li>
                        <li>Sistema notifiche in-app con campanella</li>
                        <li>Interfaccia responsive per tutti i dispositivi</li>
                        <li>Generazione automatica preventivi pulizie in tempo reale</li>
                    </ul>
                </div>

                <div class="service-category">
                    <h3>
                        🔧 Dashboard Amministratore Avanzata
                        <span class="service-price">CHF 2'000</span>
                    </h3>
                    <ul class="service-list">
                        <li>Pannello controllo completo con statistiche real-time</li>
                        <li>Gestione prenotazioni (conferma, modifica, annullamento)</li>
                        <li>Controllo disponibilità sala con calendario admin</li>
                        <li>Gestione servizi, prezzi e fasce orarie</li>
                        <li>Analytics avanzate con grafici e metriche</li>
                        <li>Report automatici giornalieri, settimanali, mensili</li>
                        <li>Gestione database utenti e famiglie</li>
                        <li>Sistema di backup e sicurezza dati</li>
                        <li>Esportazione dati in CSV/PDF</li>
                        <li>Pannello notifiche amministratore</li>
                        <li>Generazione preventivi automatizzata per servizi pulizie</li>
                        <li>Generazione fatture automatizzata con intestazione Centro Sinapsi</li>
                        <li>Sistema fatturazione con IBAN, riferimenti e codici QR</li>
                        <li>Pagamenti Stripe Link integrati per tutti i servizi</li>
                        <li>Gestione form digitali per preventivi pulizie personalizzati</li>
                    </ul>
                </div>

                <div class="service-category">
                    <h3>
                        📱 Integrazione WhatsApp Twilio
                        <span class="service-price">CHF 800</span>
                    </h3>
                    <ul class="service-list">
                        <li>Setup account Twilio professionale</li>
                        <li>Integrazione API WhatsApp Business</li>
                        <li>Notifiche automatiche conferma prenotazioni</li>
                        <li>Promemoria automatici 24h e 2h prima</li>
                        <li>Messaggi personalizzati per ogni servizio</li>
                        <li>Template professionali per comunicazioni</li>
                        <li>Sistema di invio bulk per comunicazioni importanti</li>
                        <li>Tracking consegna e lettura messaggi</li>
                        <li>Gestione opt-in/opt-out clienti</li>
                        <li>Dashboard monitoraggio invii</li>
                    </ul>
                </div>

                <div class="service-category">
                    <h3>
                        🤖 Sistema Automazioni e Cron Jobs
                        <span class="service-price">CHF 600</span>
                    </h3>
                    <ul class="service-list">
                        <li>Promemoria automatici personalizzati</li>
                        <li>Pulizia automatica database vecchie prenotazioni</li>
                        <li>Backup automatici giornalieri</li>
                        <li>Report statistici settimanali automatici</li>
                        <li>Sincronizzazione dati in tempo reale</li>
                        <li>Monitoraggio sistema e alert errori</li>
                        <li>Aggiornamento automatico disponibilità</li>
                        <li>Scadenza automatica prenotazioni non confermate</li>
                        <li>Archiviazione automatica dati storici</li>
                        <li>Sistema di logging completo</li>
                    </ul>
                </div>

                <div class="service-category">
                    <h3>
                        📧 Sistema Email Professionale
                        <span class="service-price">CHF 400</span>
                    </h3>
                    <ul class="service-list">
                        <li>Setup email transazionali con Nodemailer</li>
                        <li>Template email professionali responsive</li>
                        <li>Email conferma registrazione e verifica</li>
                        <li>Conferme prenotazioni personalizzate</li>
                        <li>Email promemoria automatici</li>
                        <li>Newsletter e comunicazioni di massa</li>
                        <li>Email recupero password sicure</li>
                        <li>Tracking apertura e click email</li>
                        <li>Sistema anti-spam e deliverability</li>
                        <li>Log completo invii email</li>
                    </ul>
                </div>

                <div class="service-category">
                    <h3>
                        🎨 Servizio Fotografico e Video
                        <span class="service-price">CHF 700</span>
                    </h3>
                    <ul class="service-list">
                        <li>Servizio fotografico professionale del centro</li>
                        <li>Foto degli spazi (sala eventi, mensa, aree gioco)</li>
                        <li>Foto dei servizi e attività</li>
                        <li>Video promozionale del centro (2-3 minuti)</li>
                        <li>Post-produzione e editing professionale</li>
                        <li>Ottimizzazione immagini per web</li>
                        <li>Creazione gallery fotografica nell'app</li>
                        <li>Video testimonials clienti</li>
                        <li>Materiale per social media</li>
                        <li>Foto professionali per brochure e marketing</li>
                    </ul>
                </div>

                <div class="service-category">
                    <h3>
                        🚀 Setup Tecnico e SEO Avanzato
                        <span class="service-price">CHF 1'000</span>
                    </h3>
                    <ul class="service-list">
                        <li>Configurazione hosting premium Infomaniak</li>
                        <li>Setup dominio centrosinapsi.ch</li>
                        <li>Certificati SSL e sicurezza avanzata</li>
                        <li>Ottimizzazione SEO on-page completa per tutti i servizi</li>
                        <li>Ricerca parole chiave per pulizie, doposcuola, mensa</li>
                        <li>Setup Google Business Profile ottimizzato</li>
                        <li>Integrazione Google Analytics e Search Console</li>
                        <li>Ottimizzazione velocità e performance Core Web Vitals</li>
                        <li>Schema markup per servizi locali</li>
                        <li>Sitemap XML e robots.txt ottimizzati</li>
                        <li>Configurazione backup automatici</li>
                        <li>Monitoraggio uptime e disponibilità</li>
                        <li>Formazione completa utilizzo piattaforma</li>
                        <li>Strategia SEO locale per area Ticino</li>
                    </ul>
                </div>

            </div>
        </div>

        <div class="section">
            <h2>💻 Stack Tecnologico Premium</h2>
            <div class="tech-stack">
                <h3>Tecnologie utilizzate per garantire performance, sicurezza e scalabilità</h3>
                <div class="tech-grid">
                    <div class="tech-item">
                        <h4>Next.js 14</h4>
                        <p>Framework React avanzato</p>
                    </div>
                    <div class="tech-item">
                        <h4>TypeScript</h4>
                        <p>Codice sicuro e scalabile</p>
                    </div>
                    <div class="tech-item">
                        <h4>Prisma ORM</h4>
                        <p>Database relazionale</p>
                    </div>
                    <div class="tech-item">
                        <h4>NextAuth.js</h4>
                        <p>Autenticazione sicura</p>
                    </div>
                    <div class="tech-item">
                        <h4>Tailwind CSS</h4>
                        <p>Design moderno</p>
                    </div>
                    <div class="tech-item">
                        <h4>Framer Motion</h4>
                        <p>Animazioni fluide</p>
                    </div>
                    <div class="tech-item">
                        <h4>Stripe API</h4>
                        <p>Pagamenti sicuri</p>
                    </div>
                    <div class="tech-item">
                        <h4>Twilio API</h4>
                        <p>WhatsApp Business</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>💰 Investimento per il Progetto</h2>
            <div class="pricing-summary">
                <h3>Riepilogo Costi Servizi</h3>

                <table class="price-table">
                    <thead>
                        <tr>
                            <th>Servizio</th>
                            <th>Prezzo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="service-name">🎯 Portale Clienti Completo</td>
                            <td class="price">CHF 2'500</td>
                        </tr>
                        <tr>
                            <td class="service-name">🔧 Dashboard Amministratore Avanzata</td>
                            <td class="price">CHF 2'000</td>
                        </tr>
                        <tr>
                            <td class="service-name">📱 Integrazione WhatsApp Twilio</td>
                            <td class="price">CHF 800</td>
                        </tr>
                        <tr>
                            <td class="service-name">🤖 Sistema Automazioni e Cron Jobs</td>
                            <td class="price">CHF 600</td>
                        </tr>
                        <tr>
                            <td class="service-name">📧 Sistema Email Professionale</td>
                            <td class="price">CHF 400</td>
                        </tr>
                        <tr>
                            <td class="service-name">🎨 Servizio Fotografico e Video</td>
                            <td class="price">CHF 700</td>
                        </tr>
                        <tr>
                            <td class="service-name">🚀 Setup Tecnico e SEO Avanzato</td>
                            <td class="price">CHF 1'000</td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>TOTALE SERVIZI</strong></td>
                            <td><strong>CHF 8'000</strong></td>
                        </tr>
                        <tr class="discount-row">
                            <td><strong>SCONTO SPECIALE (-40%)</strong></td>
                            <td><strong>- CHF 3'200</strong></td>
                        </tr>
                        <tr class="final-row">
                            <td><strong>PREZZO FINALE</strong></td>
                            <td><strong>CHF 4'800</strong></td>
                        </tr>
                    </tbody>
                </table>

                <div class="discount-highlight">
                    <h3>🎉 Offerta Speciale Centro Sinapsi</h3>
                    <p><strong>Risparmio di CHF 3'200 sul prezzo totale dei servizi!</strong></p>
                    <p>Sconto del 40% applicato come investimento per la crescita digitale del centro</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>📅 Cronoprogramma di Sviluppo</h2>
            <div class="timeline-section">
                <h3>Tempistiche di realizzazione: 10-12 settimane</h3>

                <div class="timeline-item">
                    <div class="week">Sett. 1-2</div>
                    <div class="timeline-content">
                        <strong>Setup e Progettazione</strong><br>
                        Configurazione ambiente, database design, wireframe e mockup
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="week">Sett. 3</div>
                    <div class="timeline-content">
                        <strong>Servizio Fotografico</strong><br>
                        Shooting professionale del centro, video promozionale, post-produzione
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="week">Sett. 4-6</div>
                    <div class="timeline-content">
                        <strong>Sviluppo Portale Clienti</strong><br>
                        Frontend responsive, sistema autenticazione, prenotazioni
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="week">Sett. 7-8</div>
                    <div class="timeline-content">
                        <strong>Dashboard Amministratore</strong><br>
                        Pannello admin, analytics, gestione prenotazioni, report
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="week">Sett. 9</div>
                    <div class="timeline-content">
                        <strong>Integrazioni e Automazioni</strong><br>
                        WhatsApp Twilio, email system, cron jobs, notifiche
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="week">Sett. 10-11</div>
                    <div class="timeline-content">
                        <strong>Testing e Ottimizzazioni</strong><br>
                        Test funzionali, ottimizzazione performance, correzione bug
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="week">Sett. 12</div>
                    <div class="timeline-content">
                        <strong>Deploy e Formazione</strong><br>
                        Messa online, formazione team, documentazione
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>💳 Opzioni di Pagamento</h2>
            <div class="payment-options">
                <h3>Modalità flessibili per ogni esigenza di budget</h3>

                <div class="payment-grid">
                    <div class="payment-card" data-option="rapid">
                        <h4>📅 Opzione A - Pagamento Rapido</h4>
                        <div class="payment-badge">NESSUN COSTO AGGIUNTIVO</div>
                        <table class="payment-table">
                            <tr>
                                <td><strong>Acconto alla firma (30%)</strong></td>
                                <td><strong>CHF 1'440</strong></td>
                            </tr>
                            <tr>
                                <td>A metà progetto</td>
                                <td>CHF 1'680</td>
                            </tr>
                            <tr>
                                <td>Alla consegna finale</td>
                                <td>CHF 1'680</td>
                            </tr>
                            <tr class="total-payment-row">
                                <td><strong>TOTALE</strong></td>
                                <td><strong>CHF 4'800</strong></td>
                            </tr>
                        </table>
                        <p style="font-size: 12px; margin-top: 10px; color: #666;">✅ Pagamento rapido senza costi amministrativi</p>
                        <input type="radio" name="payment-choice" value="rapid" id="payment-rapid" style="margin-top: 15px; transform: scale(1.2);">
                        <label for="payment-rapid" style="margin-left: 8px; font-weight: bold; cursor: pointer;">Scelgo questa opzione</label>
                    </div>

                    <div class="payment-card" data-option="extended">
                        <h4>📅 Opzione B - Rateizzazione Estesa</h4>
                        <div class="payment-badge extended">+CHF 60 COSTI AMMINISTRATIVI</div>
                        <table class="payment-table">
                            <tr>
                                <td><strong>Acconto alla firma (30%)</strong></td>
                                <td><strong>CHF 1'440</strong></td>
                            </tr>
                            <tr>
                                <td>36 rate mensili</td>
                                <td>CHF 95/mese</td>
                            </tr>
                            <tr>
                                <td><strong>Totale rateizzato</strong></td>
                                <td><strong>CHF 3'420</strong></td>
                            </tr>
                            <tr class="total-payment-row">
                                <td><strong>TOTALE FINALE</strong></td>
                                <td><strong>CHF 4'860</strong></td>
                            </tr>
                        </table>
                        <p style="font-size: 12px; margin-top: 10px; color: #666;">⚠️ Include CHF 60 costi amministrativi rateizzazione</p>
                        <input type="radio" name="payment-choice" value="extended" id="payment-extended" style="margin-top: 15px; transform: scale(1.2);">
                        <label for="payment-extended" style="margin-left: 8px; font-weight: bold; cursor: pointer;">Scelgo questa opzione</label>
                    </div>
                </div>

                <!-- Opzione C - Personalizzata -->
                <div class="payment-card-full" data-option="custom">
                    <h4>🎯 Opzione C - Rateizzazione Personalizzata</h4>
                    <div class="payment-badge extended">+CHF 60 COSTI AMMINISTRATIVI</div>

                    <div class="custom-payment-section">
                        <div class="custom-payment-intro">
                            <p><strong>Crea la tua rateizzazione personalizzata!</strong></p>
                            <p>L'acconto del 30% (CHF 1'440) alla firma è obbligatorio. Puoi decidere come rateizzare il restante 70%.</p>
                        </div>

                        <div class="custom-payment-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="custom-installments">📊 Numero di Rate Mensili</label>
                                    <input type="number" id="custom-installments" min="2" max="60" placeholder="Es. 12"
                                           oninput="calculateCustomPayment()" class="form-input">
                                    <small>Minimo 2 rate, massimo 60 rate</small>
                                </div>

                                <div class="form-group">
                                    <label for="custom-amount">💰 Importo per Rata (CHF)</label>
                                    <input type="number" id="custom-amount" min="50" step="5" placeholder="Es. 150"
                                           oninput="calculateCustomPayment()" class="form-input">
                                    <small>Minimo CHF 50 per rata</small>
                                </div>
                            </div>

                            <div class="calculation-result" id="customCalculation" style="display: none;">
                                <div class="calculation-table">
                                    <table class="payment-table">
                                        <tr>
                                            <td><strong>Acconto alla firma (30%)</strong></td>
                                            <td><strong>CHF 1'440</strong></td>
                                        </tr>
                                        <tr>
                                            <td id="installment-description">Rate mensili</td>
                                            <td id="installment-total">CHF 0</td>
                                        </tr>
                                        <tr>
                                            <td>Costi amministrativi</td>
                                            <td>CHF 60</td>
                                        </tr>
                                        <tr class="total-payment-row">
                                            <td><strong>TOTALE FINALE</strong></td>
                                            <td><strong id="custom-total">CHF 0</strong></td>
                                        </tr>
                                    </table>
                                </div>

                                <div class="validation-message" id="validationMessage"></div>
                            </div>
                        </div>

                        <div class="custom-payment-footer">
                            <input type="radio" name="payment-choice" value="custom" id="payment-custom" style="transform: scale(1.2);">
                            <label for="payment-custom" style="margin-left: 8px; font-weight: bold; cursor: pointer;">
                                Scelgo la mia rateizzazione personalizzata
                            </label>
                        </div>
                    </div>
                </div>

                <div class="info-box">
                    <p><strong>⚠️ Importante:</strong> I costi annuali di gestione (CHF 625/anno) sono separati e fatturati a parte dal secondo anno di attività dell'applicazione.</p>
                </div>
            </div>
        </div>

        <div class="info-box">
            <h3>💼 Costi Annuali di Gestione (Separati)</h3>
            <p>Dopo il lancio dell'applicazione, per mantenere tutti i servizi sempre attivi:</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; font-size: clamp(12px, 2.5vw, 14px);">
                <div>• <strong>Hosting Premium:</strong> CHF 180/anno</div>
                <div>• <strong>Dominio:</strong> CHF 25/anno</div>
                <div>• <strong>Twilio WhatsApp:</strong> CHF 120/anno</div>
                <div>• <strong>Assistenza tecnica:</strong> CHF 300/anno</div>
            </div>
            <p><strong>Totale gestione annuale: CHF 625 (CHF 52/mese)</strong></p>
            <p style="font-style: italic; margin-top: 10px; color: #666;">*Questi costi sono fatturati separatamente dal secondo anno di attività dell'applicazione</p>
        </div>

        <!-- Sezione Firma Digitale -->
        <div class="signature-section" id="signatureSection">
            <h2>✍️ Accettazione e Firma Digitale</h2>

            <div class="signature-content">
                <div class="acceptance-checkboxes">
                    <h4 style="color: #2c5aa0; margin-bottom: 20px; font-size: clamp(14px, 3vw, 18px);">Conferma di Accettazione</h4>

                    <div class="checkbox-item">
                        <input type="checkbox" id="accept-terms" required>
                        <label for="accept-terms">
                            <strong>Accetto tutti i servizi e le condizioni</strong> descritti in questa proposta per lo sviluppo della PWA Centro Sinapsi al prezzo finale di <strong>CHF 4'800</strong>
                        </label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="accept-timeline" required>
                        <label for="accept-timeline">
                            <strong>Confermo i tempi di realizzazione</strong> di 10-12 settimane e il cronoprogramma di sviluppo presentato
                        </label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="accept-payment" required>
                        <label for="accept-payment">
                            <strong>Ho scelto la mia opzione di pagamento</strong> tra le tre disponibili nella sezione precedente
                        </label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="accept-annual-costs" required>
                        <label for="accept-annual-costs">
                            <strong>Sono consapevole dei costi annuali di gestione</strong> di CHF 625/anno dal secondo anno di attività dell'applicazione
                        </label>
                    </div>
                </div>

                <div class="signature-canvas-container">
                    <h4 style="color: #2c5aa0; margin-bottom: 15px; font-size: clamp(14px, 3vw, 18px);">Firma Digitale</h4>
                    <p style="margin-bottom: 15px; color: #666; font-size: clamp(12px, 2.5vw, 14px);">
                        Disegna la tua firma nel riquadro sottostante usando il mouse o il dito su dispositivi touch
                    </p>

                    <canvas id="signatureCanvas" class="signature-canvas" width="500" height="200"></canvas>

                    <div class="signature-controls">
                        <button type="button" class="btn btn-clear" onclick="clearSignature()">
                            🗑️ Cancella Firma
                        </button>
                        <button type="button" class="btn btn-submit" id="submitBtn" onclick="submitProposal()" disabled>
                            ✅ Firma e Accetta Proposta
                        </button>
                    </div>

                    <div class="signature-info">
                        <p><strong>📋 Informazioni:</strong> Firmando digitalmente questa proposta, accetti tutti i termini e condizioni. La firma ha lo stesso valore legale di una firma cartacea.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messaggio di Successo -->
        <div class="success-message" id="successMessage">
            <h2>🎉 Proposta Firmata con Successo!</h2>
            <p>Grazie per aver accettato la proposta. Il contratto è ora vincolante e inizieremo subito i lavori di sviluppo.</p>
            <p><strong>Ti abbiamo inviato una copia della proposta firmata via email. Ti contatteremo entro 24 ore per organizzare il primo incontro e l'acconto.</strong></p>
        </div>

        <!-- Anteprima Firma (visibile solo dopo la firma) -->
        <div class="signature-preview" id="signaturePreview" style="display: none;">
            <h4>📋 Dettagli Firma Digitale</h4>
            <div class="signature-details">
                <div><strong>Data e Ora:</strong> <span id="signatureDate"></span></div>
                <div><strong>Cliente:</strong> Centro Sinapsi - Shote</div>
                <div><strong>Sviluppatore:</strong> Domenico Riccio</div>
                <div><strong>Importo:</strong> CHF 4'800</div>
                <div><strong>Opzione Pagamento:</strong> <span id="selectedPayment"></span></div>
                <div><strong>IP Address:</strong> <span id="clientIP"></span></div>
            </div>
            <div style="margin-top: 15px;">
                <strong>Firma:</strong><br>
                <img id="signatureImage" style="border: 1px solid #ddd; border-radius: 5px; max-width: 100%; height: auto;">
            </div>
        </div>

        <div class="cta-section">
            <h2>🚀 Trasformiamo Insieme il Centro Sinapsi!</h2>
            <p>Una soluzione digitale completa che automatizzerà tutti i processi di prenotazione e gestione clienti, portando il vostro centro nell'era digitale con tecnologie all'avanguardia.</p>
            <div style="margin-top: 30px; font-size: clamp(16px, 4vw, 22px);">
                <strong>💻 Tecnologie Premium • 📱 App Moderna • 🤖 Automazioni Smart</strong>
            </div>
        </div>

        <div class="contact-section">
            <h3>📞 Conferma e Inizio Sviluppo</h3>
            <p style="font-size: clamp(16px, 3.5vw, 20px); margin-bottom: 15px;"><strong>Domenico Riccio</strong></p>
            <p>📱 WhatsApp: 076 781 01 94</p>
            <p>✉️ Email: info@dcreativo.ch</p>
            <p style="margin-top: 25px; color: #666; font-size: clamp(12px, 2.5vw, 14px);">Questa proposta è valida per 30 giorni dalla prima apertura.</p>
        </div>
    </div>

    <script>
   // 🧪 CONFIGURAZIONE TEST MODE
const CONFIG = {
    password: 'centrosinapsi2025',
    expiryDays: 30,
    apiEndpoint: '/api/send-proposal',
    testMode: true  // 🧪 MODALITÀ TEST ATTIVA
};

// Variabili globali
let canvas = null;
let ctx = null;
let isDrawing = false;
let hasSignature = false;
let timerInterval = null;
let isExpired = false;

// Inizializzazione
document.addEventListener('DOMContentLoaded', function() {
    setupPasswordScreen();
    updateCurrentDate();

    // 🧪 IN TEST MODE: Accesso automatico senza controllo localStorage
    if (CONFIG.testMode) {
        console.log('🧪 Modalità Test: Accesso diretto senza controlli');
        // Non controlla localStorage per firme precedenti
        showProposal();
    } else {
        // Controllo normale per produzione
        if (localStorage.getItem('centrosinapsi_access')) {
            showProposal();
        }
    }
});

// Setup schermata password
function setupPasswordScreen() {
    const passwordInput = document.getElementById('passwordInput');
    passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            checkPassword();
        }
    });
}

// Controllo password
function checkPassword() {
    const password = document.getElementById('passwordInput').value;
    const errorMessage = document.getElementById('errorMessage');

    if (password === CONFIG.password) {
        // 🧪 IN TEST MODE: Non salva nel localStorage
        if (!CONFIG.testMode) {
            const accessData = {
                firstAccess: Date.now(),
                hasAccess: true
            };
            localStorage.setItem('centrosinapsi_access', JSON.stringify(accessData));
        }

        showProposal();
    } else {
        errorMessage.style.display = 'block';
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
    }
}

// Mostra la proposta
function showProposal() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('proposalContainer').style.display = 'block';

    // Inizializza tutto
    initializeSignature();

    // 🧪 IN TEST MODE: Non controlla firme precedenti
    if (!CONFIG.testMode) {
        checkStoredSignature();
    }

    setupEventListeners();
    startTimer();
    animateElements();
}

// Aggiorna la data corrente
function updateCurrentDate() {
    const now = new Date();
    const options = {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        timeZone: 'Europe/Zurich'
    };

    const formatter = new Intl.DateTimeFormat('it-IT', options);
    const currentDateFormatted = formatter.format(now);

    document.getElementById('currentDate').textContent = currentDateFormatted;
}

// Avvia il timer di 30 giorni
function startTimer() {
    // 🧪 IN TEST MODE: Timer disabilitato
    if (CONFIG.testMode) {
        document.getElementById('timerDisplay').style.display = 'none';
        return;
    }

    const accessData = JSON.parse(localStorage.getItem('centrosinapsi_access'));
    if (!accessData || !accessData.firstAccess) return;

    const firstAccess = new Date(accessData.firstAccess);
    const expiryDate = new Date(firstAccess.getTime() + (CONFIG.expiryDays * 24 * 60 * 60 * 1000));

    timerInterval = setInterval(function() {
        const now = new Date();
        const timeLeft = expiryDate - now;

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            showExpiredState();
            return;
        }

        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById('timerText').textContent = `${days}d ${hours}h ${minutes}m`;
    }, 60000);

    const now = new Date();
    const timeLeft = expiryDate - now;
    if (timeLeft > 0) {
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById('timerText').textContent = `${days}d ${hours}h ${minutes}m`;
    } else {
        showExpiredState();
    }
}

// Mostra stato scaduto
function showExpiredState() {
    isExpired = true;
    const timerDisplay = document.getElementById('timerDisplay');
    timerDisplay.classList.add('expired');
    timerDisplay.innerHTML = '⏰ <strong>PROPOSTA SCADUTA</strong> - Contatta Domenico Riccio per una nuova proposta';

    const signatureSection = document.getElementById('signatureSection');
    if (signatureSection) {
        signatureSection.style.opacity = '0.5';
        signatureSection.style.pointerEvents = 'none';
    }
}

// Inizializza il canvas per la firma
function initializeSignature() {
    canvas = document.getElementById('signatureCanvas');
    ctx = canvas.getContext('2d');

    ctx.strokeStyle = '#2c5aa0';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);
    canvas.addEventListener('touchend', stopDrawing);
}

// Gestisce eventi touch per mobile
function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;

    if (e.type === 'touchstart') {
        isDrawing = true;
        ctx.beginPath();
        ctx.moveTo(x, y);
    } else if (e.type === 'touchmove' && isDrawing) {
        ctx.lineTo(x, y);
        ctx.stroke();
        hasSignature = true;
        checkFormValidity();
    }
}

// Inizia il disegno
function startDrawing(e) {
    if (isExpired) return;
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

// Disegna
function draw(e) {
    if (!isDrawing || isExpired) return;

    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    hasSignature = true;
    checkFormValidity();
}

// Ferma il disegno
function stopDrawing() {
    isDrawing = false;
}

// Cancella la firma
function clearSignature() {
    if (isExpired) return;
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    hasSignature = false;
    checkFormValidity();
}

// Setup event listeners
function setupEventListeners() {
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', checkFormValidity);
    });

    document.querySelectorAll('input[name="payment-choice"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updatePaymentSelection(this.value);
            checkFormValidity();
        });
    });

    document.getElementById('custom-installments').addEventListener('input', calculateCustomPayment);
    document.getElementById('custom-amount').addEventListener('input', calculateCustomPayment);
}

// Aggiorna la selezione del pagamento
function updatePaymentSelection(selectedOption) {
    document.querySelectorAll('.payment-card, .payment-card-full').forEach(card => {
        card.classList.remove('selected');
    });

    const selectedCard = document.querySelector(`[data-option="${selectedOption}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
    }

    const customSection = document.getElementById('customCalculation');
    if (selectedOption === 'custom') {
        calculateCustomPayment();
    }
}

// 🔧 CALCOLA RATEIZZAZIONE PERSONALIZZATA - COMPLETA
function calculateCustomPayment() {
    const installments = parseInt(document.getElementById('custom-installments').value) || 0;
    const amount = parseFloat(document.getElementById('custom-amount').value) || 0;
    const customSection = document.getElementById('customCalculation');
    const validationMessage = document.getElementById('validationMessage');

    if (installments === 0 || amount === 0) {
        customSection.style.display = 'none';
        return;
    }

    // Calcoli
    const baseAmount = 4800; // Prezzo totale
    const downPayment = 1440; // 30% acconto obbligatorio
    const remainingAmount = baseAmount - downPayment; // CHF 3360
    const adminCosts = 60; // Costi amministrativi

    const totalInstallments = installments * amount;
    const totalWithAdmin = totalInstallments + adminCosts;
    const finalTotal = downPayment + totalWithAdmin;

    // Validazione
    let isValid = true;
    let message = '';

    if (installments < 2 || installments > 60) {
        isValid = false;
        message = '⚠️ Il numero di rate deve essere tra 2 e 60';
    } else if (amount < 50) {
        isValid = false;
        message = '⚠️ L\'importo minimo per rata è CHF 50';
    } else if (totalInstallments < remainingAmount) {
        const shortage = remainingAmount - totalInstallments;
        isValid = false;
        message = `⚠️ Importo insufficiente! Mancano CHF ${shortage.toFixed(2)} per coprire il saldo rimanente`;
    } else if (totalInstallments > remainingAmount + 500) {
        const excess = totalInstallments - remainingAmount;
        isValid = false;
        message = `⚠️ Importo eccessivo! Eccedenza di CHF ${excess.toFixed(2)} rispetto al saldo rimanente`;
    } else {
        message = '✅ Rateizzazione valida e conforme';
    }

    // Aggiorna la tabella
    document.getElementById('installment-description').textContent = `${installments} rate da CHF ${amount}`;
    document.getElementById('installment-total').textContent = `CHF ${totalInstallments.toFixed(2)}`;
    document.getElementById('custom-total').textContent = `CHF ${finalTotal.toFixed(2)}`;

    // Mostra messaggio di validazione
    validationMessage.textContent = message;
    validationMessage.className = `validation-message ${isValid ? 'valid' : 'invalid'}`;

    // Mostra sezione
    customSection.style.display = 'block';

    // Abilita/disabilita radio button
    const customRadio = document.getElementById('payment-custom');
    customRadio.disabled = !isValid;

    if (!isValid && customRadio.checked) {
        customRadio.checked = false;
        checkFormValidity();
    }
}

// Controlla validità del form
function checkFormValidity() {
    const checkboxes = document.querySelectorAll('#signatureSection input[type="checkbox"]');
    const paymentSelected = document.querySelector('input[name="payment-choice"]:checked');

    let allChecked = true;
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            allChecked = false;
        }
    });

    const submitBtn = document.getElementById('submitBtn');
    const isFormValid = allChecked && hasSignature && paymentSelected && !isExpired;

    submitBtn.disabled = !isFormValid;

    if (isFormValid) {
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
    } else {
        submitBtn.style.opacity = '0.6';
        submitBtn.style.cursor = 'not-allowed';
    }
}

// Controlla se c'è una firma salvata
function checkStoredSignature() {
    const storedData = localStorage.getItem('centrosinapsi_signature');
    if (storedData) {
        const signatureData = JSON.parse(storedData);
        showSignedState(signatureData);
    }
}

// Mostra stato firmato
function showSignedState(signatureData) {
    document.getElementById('statusBanner').style.display = 'block';
    document.getElementById('signatureSection').style.display = 'none';
    document.getElementById('successMessage').classList.add('show');

    const preview = document.getElementById('signaturePreview');
    preview.style.display = 'block';

    document.getElementById('signatureDate').textContent = signatureData.timestamp;
    document.getElementById('selectedPayment').textContent = signatureData.paymentOption;
    document.getElementById('clientIP').textContent = signatureData.ipAddress || 'N/A';
    document.getElementById('signatureImage').src = signatureData.signatureData;
}

// 🚀 GENERA PDF PROFESSIONALE - VERSIONE COMPLETA OTTIMIZZATA
async function generatePDF() {
    return new Promise(async (resolve, reject) => {
        try {
            const { jsPDF } = window.jspdf;

            // Crea nuovo PDF in formato A4
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                compress: true
            });

            // Dimensioni A4 in mm
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);

            let currentY = margin;

            // 📋 FUNZIONI HELPER PER IL PDF
            function addText(text, x, y, options = {}) {
                const fontSize = options.fontSize || 10;
                const fontStyle = options.fontStyle || 'normal';
                const align = options.align || 'left';
                const maxWidth = options.maxWidth || contentWidth;

                pdf.setFontSize(fontSize);
                pdf.setFont('helvetica', fontStyle);

                if (align === 'center') {
                    x = pageWidth / 2;
                }

                if (text.length > 80 && maxWidth) {
                    const lines = pdf.splitTextToSize(text, maxWidth);
                    pdf.text(lines, x, y, { align: align });
                    return y + (lines.length * fontSize * 0.4);
                } else {
                    pdf.text(text, x, y, { align: align });
                    return y + (fontSize * 0.4);
                }
            }

            function addSection(title, content = '', yPosition) {
                // Titolo sezione
                pdf.setFillColor(44, 90, 160);
                pdf.rect(margin, yPosition - 5, contentWidth, 8, 'F');

                pdf.setTextColor(255, 255, 255);
                addText(title, margin + 3, yPosition, { fontSize: 12, fontStyle: 'bold' });

                pdf.setTextColor(0, 0, 0);
                yPosition += 15;

                if (content) {
                    yPosition = addText(content, margin, yPosition, { fontSize: 10 }) + 5;
                }

                return yPosition;
            }

            function checkPageBreak(neededSpace) {
                if (currentY + neededSpace > pageHeight - margin) {
                    pdf.addPage();
                    currentY = margin;
                    return true;
                }
                return false;
            }

            // 🎯 HEADER DELLA PROPOSTA
            pdf.setFillColor(44, 90, 160);
            pdf.rect(0, 0, pageWidth, 25, 'F');

            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.text('CENTRO SINAPSI - PROPOSTA PWA', pageWidth/2, 12, { align: 'center' });

            pdf.setFontSize(12);
            pdf.text('Progressive Web Application Completa', pageWidth/2, 18, { align: 'center' });

            currentY = 35;

            // 📋 INFORMAZIONI AZIENDE - LAYOUT CORRETTO
            pdf.setTextColor(0, 0, 0);

            // Reset posizione Y dopo header
            currentY = 35;

            // Colonna sinistra - Sviluppatore
            let leftY = currentY;
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Domenico Riccio', margin, leftY);

            leftY += 6;
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'normal');
            pdf.text('Web & App Solutions', margin, leftY);

            leftY += 4;
            pdf.text('Via Ol Mött 6, 6703 Osogna, Svizzera', margin, leftY);

            leftY += 4;
            pdf.text('Tel: 076 781 01 94 | Email: info@dcreativo.ch', margin, leftY);

            // Colonna destra - Cliente
            let rightY = currentY;
            const rightX = pageWidth - margin;

            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Centro Sinapsi', rightX, rightY, { align: 'right' });

            rightY += 6;
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'normal');
            pdf.text('Shote - Proprietaria', rightX, rightY, { align: 'right' });

            rightY += 4;
            pdf.text('Via Toron d\'Örz 7, 6703 Osogna', rightX, rightY, { align: 'right' });

            rightY += 4;
            pdf.text('Tel: 078 846 06 87', rightX, rightY, { align: 'right' });

            rightY += 4;
            const today = new Date().toLocaleDateString('it-IT');
            pdf.text(`Data: ${today}`, rightX, rightY, { align: 'right' });

            // Posiziona Y dopo le informazioni aziendali
            currentY = Math.max(leftY, rightY) + 10;

            // 🎯 SEZIONE SERVIZI
            currentY = addSection('SERVIZI DI SVILUPPO INCLUSI', '', currentY);

            const services = [
                { name: 'Portale Clienti Completo', price: 'CHF 2\'500',
                  features: ['Sistema registrazione e login sicuro', 'Dashboard personalizzata famiglie', 'Gestione profili bambini', 'Prenotazioni sala eventi', 'Iscrizione mensa scolastica', 'Richiesta doposcuola', 'Preventivi pulizie digitali', 'Pagamenti Stripe Link'] },
                { name: 'Dashboard Amministratore Avanzata', price: 'CHF 2\'000',
                  features: ['Pannello controllo completo', 'Gestione prenotazioni', 'Analytics avanzate', 'Report automatici', 'Gestione database utenti', 'Generazione fatture automatica'] },
                { name: 'Integrazione WhatsApp Twilio', price: 'CHF 800',
                  features: ['Setup account Twilio professionale', 'Notifiche automatiche conferma', 'Promemoria automatici', 'Template professionali'] },
                { name: 'Sistema Automazioni e Cron Jobs', price: 'CHF 600',
                  features: ['Promemoria automatici', 'Backup automatici', 'Report statistici', 'Monitoraggio sistema'] },
                { name: 'Sistema Email Professionale', price: 'CHF 400',
                  features: ['Setup email transazionali', 'Template responsive', 'Newsletter', 'Tracking email'] },
                { name: 'Servizio Fotografico e Video', price: 'CHF 700',
                  features: ['Fotografie professionali centro', 'Video promozionale', 'Post-produzione', 'Gallery web'] },
                { name: 'Setup Tecnico e SEO Avanzato', price: 'CHF 1\'000',
                  features: ['Hosting premium Infomaniak', 'Ottimizzazione SEO completa', 'Google Business Profile', 'Formazione utilizzo'] }
            ];

            services.forEach(service => {
                checkPageBreak(25);

                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin, currentY - 3, contentWidth, 20, 'F');

                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(44, 90, 160);
                pdf.text(service.name, margin + 3, currentY + 2);

                pdf.setTextColor(76, 175, 80);
                pdf.text(service.price, pageWidth - margin - 3, currentY + 2, { align: 'right' });

                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(85, 85, 85);

                let featY = currentY + 7;
                service.features.slice(0, 3).forEach(feature => {
                    pdf.text(`• ${feature}`, margin + 6, featY);
                    featY += 3.5;
                });

                currentY += 25;
            });

            // 💰 RIEPILOGO PREZZI
            checkPageBreak(40);
            currentY = addSection('INVESTIMENTO PER IL PROGETTO', '', currentY);

            const priceTableData = [
                ['Servizio', 'Prezzo'],
                ['Portale Clienti Completo', 'CHF 2\'500'],
                ['Dashboard Amministratore', 'CHF 2\'000'],
                ['Integrazione WhatsApp', 'CHF 800'],
                ['Sistema Automazioni', 'CHF 600'],
                ['Sistema Email', 'CHF 400'],
                ['Servizio Fotografico', 'CHF 700'],
                ['Setup Tecnico e SEO', 'CHF 1\'000'],
                ['TOTALE SERVIZI', 'CHF 8\'000'],
                ['SCONTO SPECIALE (-40%)', '- CHF 3\'200'],
                ['PREZZO FINALE', 'CHF 4\'800']
            ];

            // Header tabella
            pdf.setFillColor(44, 90, 160);
            pdf.rect(margin, currentY, contentWidth, 8, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Servizio', margin + 3, currentY + 5);
            pdf.text('Prezzo', pageWidth - margin - 3, currentY + 5, { align: 'right' });

            currentY += 8;
            pdf.setTextColor(0, 0, 0);

            // Righe tabella
            priceTableData.slice(1).forEach((row, index) => {
                const isTotal = index >= 7;
                const isDiscount = index === 8;
                const isFinal = index === 9;

                if (isFinal) {
                    pdf.setFillColor(44, 90, 160);
                    pdf.rect(margin, currentY, contentWidth, 6, 'F');
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFont('helvetica', 'bold');
                } else if (isDiscount) {
                    pdf.setFillColor(232, 245, 232);
                    pdf.rect(margin, currentY, contentWidth, 6, 'F');
                    pdf.setTextColor(76, 175, 80);
                    pdf.setFont('helvetica', 'bold');
                } else if (isTotal) {
                    pdf.setFillColor(240, 247, 255);
                    pdf.rect(margin, currentY, contentWidth, 6, 'F');
                    pdf.setTextColor(44, 90, 160);
                    pdf.setFont('helvetica', 'bold');
                } else {
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont('helvetica', 'normal');
                }

                pdf.setFontSize(9);
                pdf.text(row[0], margin + 3, currentY + 4);
                pdf.text(row[1], pageWidth - margin - 3, currentY + 4, { align: 'right' });

                currentY += 6;
            });

            // 📅 CRONOPROGRAMMA
            checkPageBreak(50);
            currentY += 10;
            currentY = addSection('CRONOPROGRAMMA DI SVILUPPO', 'Tempistiche: 10-12 settimane', currentY);

            const timeline = [
                ['Sett. 1-2', 'Setup e Progettazione'],
                ['Sett. 3', 'Servizio Fotografico'],
                ['Sett. 4-6', 'Sviluppo Portale Clienti'],
                ['Sett. 7-8', 'Dashboard Amministratore'],
                ['Sett. 9', 'Integrazioni e Automazioni'],
                ['Sett. 10-11', 'Testing e Ottimizzazioni'],
                ['Sett. 12', 'Deploy e Formazione']
            ];

            timeline.forEach(item => {
                pdf.setFillColor(227, 242, 253);
                pdf.rect(margin, currentY, 25, 6, 'F');

                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(44, 90, 160);
                pdf.text(item[0], margin + 12.5, currentY + 4, { align: 'center' });

                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                pdf.text(item[1], margin + 28, currentY + 4);

                currentY += 8;
            });

            // 💳 OPZIONE PAGAMENTO SELEZIONATA
            checkPageBreak(25);
            currentY += 10;
            currentY = addSection('MODALITA\' DI PAGAMENTO SCELTA', '', currentY);

            const selectedPayment = document.querySelector('input[name="payment-choice"]:checked');
            let paymentText = 'Nessuna opzione selezionata';

            if (selectedPayment) {
                switch(selectedPayment.value) {
                    case 'rapid':
                        paymentText = 'Opzione A - Pagamento Rapido: Acconto CHF 1\'440 + 2 rate';
                        break;
                    case 'extended':
                        paymentText = 'Opzione B - Rateizzazione Estesa: Acconto CHF 1\'440 + 36 rate da CHF 95';
                        break;
                    case 'custom':
                        const installments = document.getElementById('custom-installments').value;
                        const amount = document.getElementById('custom-amount').value;
                        paymentText = `Opzione C - Personalizzata: Acconto CHF 1\'440 + ${installments} rate da CHF ${amount}`;
                        break;
                }
            }

            currentY = addText(paymentText, margin, currentY, { fontSize: 11, fontStyle: 'bold' });

            // ✍️ SEZIONE FIRMA DIGITALE
            checkPageBreak(60);
            currentY += 15;
            currentY = addSection('ACCETTAZIONE E FIRMA DIGITALE', '', currentY);

            // Box firma
            pdf.setDrawColor(44, 90, 160);
            pdf.setLineWidth(1);
            pdf.rect(margin, currentY, contentWidth, 40);

            // Dettagli firma
            const signatureDate = new Date().toLocaleString('it-IT');
            currentY += 8;

            pdf.setFontSize(10);
            pdf.text(`Data e Ora Firma: ${signatureDate}`, margin + 5, currentY);
            currentY += 5;
            pdf.text('Cliente: Centro Sinapsi - Shote', margin + 5, currentY);
            currentY += 5;
            pdf.text('Sviluppatore: Domenico Riccio', margin + 5, currentY);
            currentY += 5;
            pdf.text('Importo Contratto: CHF 4\'800', margin + 5, currentY);

            // 🖊️ AGGIUNGI FIRMA DIGITALE AL PDF
            if (hasSignature && canvas) {
                try {
                    // Cattura firma dal canvas
                    const signatureImageData = canvas.toDataURL('image/png', 1.0);

                    // Aggiungi firma al PDF
                    const signatureY = currentY - 15;
                    const signatureWidth = 60;
                    const signatureHeight = 20;
                    const signatureX = pageWidth - margin - signatureWidth - 5;

                    pdf.addImage(signatureImageData, 'PNG', signatureX, signatureY, signatureWidth, signatureHeight);

                    // Etichetta firma
                    pdf.setFontSize(8);
                    pdf.setTextColor(102, 102, 102);
                    pdf.text('Firma Digitale Cliente', signatureX + signatureWidth/2, signatureY + signatureHeight + 4, { align: 'center' });

                } catch (error) {
                    console.error('Errore aggiunta firma al PDF:', error);
                    // Fallback: testo firma
                    pdf.setFontSize(10);
                    pdf.setTextColor(76, 175, 80);
                    pdf.text('[FIRMA DIGITALE PRESENTE]', pageWidth - margin - 5, currentY, { align: 'right' });
                }
            }

            // 📝 FOOTER LEGALE
            currentY += 35;
            checkPageBreak(20);

            pdf.setFontSize(8);
            pdf.setTextColor(102, 102, 102);
            const legalText = 'Questo documento costituisce contratto vincolante tra le parti. La firma digitale ha lo stesso valore legale di una firma autografa secondo il Codice dell\'Amministrazione Digitale.';
            currentY = addText(legalText, margin, currentY, { fontSize: 8, maxWidth: contentWidth });

            // 📞 CONTATTI FOOTER
            pdf.setFillColor(44, 90, 160);
            pdf.rect(0, pageHeight - 20, pageWidth, 20, 'F');

            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(10);
            pdf.text('Domenico Riccio - Web & App Solutions', pageWidth/2, pageHeight - 12, { align: 'center' });
            pdf.setFontSize(8);
            pdf.text('Tel: 076 781 01 94 | Email: info@dcreativo.ch | Web: dcreativo.ch', pageWidth/2, pageHeight - 6, { align: 'center' });

            console.log('✅ PDF generato con successo');
            resolve(pdf);

        } catch (error) {
            console.error('❌ Errore generazione PDF:', error);
            reject(error);
        }
    });
}

// 🚀 SOTTOMISSIONE PROPOSTA COMPLETA
async function submitProposal() {
    if (!hasSignature || isExpired) return;

    // Verifica che tutti i campi siano compilati
    const checkboxes = document.querySelectorAll('#signatureSection input[type="checkbox"]');
    const paymentSelected = document.querySelector('input[name="payment-choice"]:checked');

    let allChecked = true;
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            allChecked = false;
        }
    });

    if (!allChecked || !paymentSelected) {
        alert('⚠️ Completa tutti i campi richiesti prima di firmare');
        return;
    }

    // Mostra loading
    document.getElementById('loadingScreen').style.display = 'flex';

    try {
        // Prepara dati firma con struttura corretta per email
        const paymentOptionDetails = getPaymentOptionDetails(paymentSelected.value);
        const signatureData = {
            date: new Date().toLocaleString('it-IT'),
            timestamp: new Date().toLocaleString('it-IT'),
            paymentOption: paymentOptionDetails, // ✅ Oggetto completo invece di stringa
            signatureData: canvas.toDataURL('image/png'),
            ipAddress: await getClientIP(),
            userAgent: navigator.userAgent,
            checkboxStates: {
                terms: document.getElementById('accept-terms').checked,
                timeline: document.getElementById('accept-timeline').checked,
                payment: document.getElementById('accept-payment').checked,
                annualCosts: document.getElementById('accept-annual-costs').checked
            }
        };

        // 🧪 IN TEST MODE: Permetti multiple firme
        if (!CONFIG.testMode) {
            localStorage.setItem('centrosinapsi_signature', JSON.stringify(signatureData));
        }

        // 📄 GENERA UN SOLO PDF DI ALTA QUALITÀ
        console.log('📄 Generazione PDF di alta qualità...');
        const pdf = await generatePDF();

        // 💾 PREPARA PDF PER DOWNLOAD E EMAIL (STESSO IDENTICO FILE)
        const pdfBlob = pdf.output('blob');

        // ✅ CONVERTI PDF IN BASE64 PULITO (SENZA PREFISSO DATA:)
        const pdfArrayBuffer = await pdfBlob.arrayBuffer();
        const pdfUint8Array = new Uint8Array(pdfArrayBuffer);
        const pdfBase64Clean = btoa(String.fromCharCode.apply(null, pdfUint8Array));

        console.log('✅ PDF generato - Dimensione:', Math.round(pdfBlob.size / 1024), 'KB');
        console.log('✅ Base64 generato - Lunghezza:', pdfBase64Clean.length, 'caratteri');

        // 📧 INVIA EMAIL CON PDF OTTIMIZZATO (STESSO DEL DOWNLOAD)
        console.log('📧 Invio email con PDF ottimizzato...');
        const emailData = {
            signatureData: signatureData,
            pdfBase64: pdfBase64Clean, // ✅ Base64 pulito senza prefisso
            pdfSize: Math.round(pdfBlob.size / 1024), // ✅ Dimensione per verifica
            proposal: {
                client: 'Centro Sinapsi - Shote',
                amount: 'CHF 4\'800',
                services: 'PWA Completa Centro Sinapsi',
                payment: signatureData.paymentOption.description
            }
        };

        // Invio email con PDF ottimizzato
        const emailResult = await sendProposalEmail(emailData);

        // 📥 DOWNLOAD AUTOMATICO PDF (STESSA VERSIONE)
        console.log('📥 Download automatico PDF...');
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(pdfBlob);
        downloadLink.download = 'Proposta_Centro_Sinapsi_Firmata.pdf';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        // Cleanup URL object
        setTimeout(() => URL.revokeObjectURL(downloadLink.href), 1000);

        // Nascondi loading
        document.getElementById('loadingScreen').style.display = 'none';

        // Mostra successo
        showSignedState(signatureData);

        // Log successo con dati reali
        console.log('✅ Proposta inviata con successo');
        console.log('📧 Email cliente inviata:', emailResult.clientMessageId);
        console.log('📧 Email programmatore inviata:', emailResult.developerMessageId);
        console.log('💳 Riferimento pagamento:', emailResult.paymentReference);

    } catch (error) {
        console.error('❌ Errore invio proposta:', error);
        document.getElementById('loadingScreen').style.display = 'none';

        // Messaggi di errore specifici
        let errorMessage = '❌ Errore durante l\'invio della proposta.';

        if (error.message.includes('connessione')) {
            errorMessage = '❌ Errore di connessione. Verifica la tua connessione internet e riprova.';
        } else if (error.message.includes('server')) {
            errorMessage = '❌ Errore del server. Riprova tra qualche minuto.';
        } else if (error.message.includes('email')) {
            errorMessage = '❌ Errore invio email. La proposta è stata firmata ma l\'email potrebbe non essere stata inviata.';
        } else if (error.message.includes('PDF')) {
            errorMessage = '❌ Errore generazione PDF. Riprova o contatta il supporto.';
        }

        alert(errorMessage + '\n\nSe il problema persiste, contatta:\n📞 076 781 01 94\n📧 info@dcreativo.ch');
    }
}

// 🔧 FUNZIONE DETTAGLI OPZIONE PAGAMENTO COMPLETA
function getPaymentOptionDetails(option) {
    switch(option) {
        case 'rapid':
            return {
                type: 'rapid',
                description: 'Opzione A - Pagamento Rapido',
                details: 'Acconto CHF 1\'440 + 2 rate (CHF 1\'680 ciascuna)',
                total: 'CHF 4\'800',
                installments: '3 rate totali',
                adminCosts: 'CHF 0 (nessun costo aggiuntivo)'
            };
        case 'extended':
            return {
                type: 'extended',
                description: 'Opzione B - Rateizzazione Estesa',
                details: 'Acconto CHF 1\'440 + 36 rate mensili da CHF 95',
                total: 'CHF 4\'860',
                installments: '37 rate totali',
                adminCosts: 'CHF 60 (costi amministrativi)'
            };
        case 'custom':
            const installments = document.getElementById('custom-installments').value;
            const amount = document.getElementById('custom-amount').value;
            const totalCustom = 1440 + (installments * amount) + 60;
            return {
                type: 'custom',
                description: 'Opzione C - Rateizzazione Personalizzata',
                details: `Acconto CHF 1\'440 + ${installments} rate mensili da CHF ${amount}`,
                total: `CHF ${totalCustom}`,
                installments: `${parseInt(installments) + 1} rate totali`,
                adminCosts: 'CHF 60 (costi amministrativi)'
            };
        default:
            return {
                type: 'unknown',
                description: 'Opzione non specificata',
                details: 'Contattare per chiarimenti',
                total: 'CHF 4\'800',
                installments: 'Da definire',
                adminCosts: 'Da definire'
            };
    }
}

// Funzioni helper - mantieni per compatibilità
function getPaymentOptionText(option) {
    const details = getPaymentOptionDetails(option);
    return details.description;
}

async function getClientIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        return 'N/A';
    }
}

// 📧 INVIO EMAIL REALE TRAMITE API - VERSIONE OTTIMIZZATA
async function sendProposalEmail(emailData) {
    try {
        console.log('📧 Invio email tramite API...');
        console.log('📊 Dati firma:', {
            date: emailData.signatureData.date,
            paymentOption: emailData.signatureData.paymentOption.description,
            total: emailData.signatureData.paymentOption.total,
            clientIP: emailData.signatureData.ipAddress
        });
        console.log('📄 PDF per email - Dimensione:', emailData.pdfSize, 'KB, Base64 lunghezza:', emailData.pdfBase64.length);

        // ✅ Prepara dati ottimizzati per l'API
        const apiData = {
            signatureData: {
                date: emailData.signatureData.date,
                timestamp: emailData.signatureData.timestamp,
                clientIP: emailData.signatureData.ipAddress,
                paymentOption: {
                    description: emailData.signatureData.paymentOption.description,
                    details: emailData.signatureData.paymentOption.details,
                    total: emailData.signatureData.paymentOption.total
                }
            },
            pdfBase64: emailData.pdfBase64, // ✅ PDF ottimizzato in base64 pulito
            pdfSize: emailData.pdfSize,     // ✅ Dimensione per verifica
            pdfQuality: 'optimized'         // ✅ Flag per l'API
        };

        const response = await fetch('/api/send-proposal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(apiData)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            console.log('✅ Email inviate con successo!');
            console.log('📧 ID Cliente:', result.clientMessageId);
            console.log('📧 ID Programmatore:', result.developerMessageId);
            console.log('💳 Riferimento Pagamento:', result.paymentReference);
            console.log('📄 PDF allegato verificato:', result.pdfAttached ? '✅' : '❌');
            return result;
        } else {
            throw new Error(result.error || 'Errore invio email');
        }

    } catch (error) {
        console.error('❌ Errore invio email:', error);

        // Gestione errori specifici
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            throw new Error('Errore di connessione. Verifica la connessione internet e riprova.');
        } else if (error.message.includes('500')) {
            throw new Error('Errore server. Riprova tra qualche minuto o contatta il supporto.');
        } else if (error.message.includes('404')) {
            throw new Error('Servizio email non disponibile. Contatta il supporto.');
        } else {
            throw new Error(`Errore invio email: ${error.message}`);
        }
    }
}

// Animazioni elementi
function animateElements() {
    const sections = document.querySelectorAll('.section');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.animation = 'fadeInUp 0.6s ease-out forwards';
            }
        });
    }, { threshold: 0.1 });

    sections.forEach(section => {
        observer.observe(section);
    });
}

// Event listener per stampa
window.addEventListener('beforeprint', function() {
    document.getElementById('signatureSection').style.display = 'none';
    document.getElementById('timerDisplay').style.display = 'none';
});

window.addEventListener('afterprint', function() {
    document.getElementById('signatureSection').style.display = 'block';
    if (!CONFIG.testMode) {
        document.getElementById('timerDisplay').style.display = 'block';
    }
});

// 🔧 Utility per debug
if (CONFIG.testMode) {
    window.debugFunctions = {
        clearSignature: () => localStorage.removeItem('centrosinapsi_signature'),
        clearAccess: () => localStorage.removeItem('centrosinapsi_access'),
        showData: () => console.log({
            signature: localStorage.getItem('centrosinapsi_signature'),
            access: localStorage.getItem('centrosinapsi_access')
        }),
        testPDF: generatePDF
    };
    console.log('🧪 Test Mode: Funzioni debug disponibili in window.debugFunctions');
}
    </script>
